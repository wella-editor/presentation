<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ë°œí‘œ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #3b82f6; /* Blue */
            --success: #10b981; /* Green */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --radius: 24px;
        }

        body {
            font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-main);
            overflow: hidden; /* ë°°ê²½ ê³ ì • */
        }

        /* --- ê³µí†µ UI ì»´í¬ë„ŒíŠ¸ --- */
        .container {
            width: 100%;
            height: 100%;
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }
        .container.active { display: flex; }

        .card-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            padding: 40px;
            width: 100%;
            max-width: 800px; /* ì ë‹¹í•œ ë„ˆë¹„ ì œí•œ */
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-top: 0; font-size: 1.8rem; text-align: center; color: #111; margin-bottom: 20px; }
        
        /* --- 1. ë©”ì¸ í™”ë©´ (ì¹´ë“œ ë²„íŠ¼) --- */
        .main-menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 800px;
            width: 100%;
        }

        .menu-card {
            background: white;
            border-radius: var(--radius);
            height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .menu-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        .card-green { color: var(--success); }
        .card-green:hover { border-color: var(--success); background: #ecfdf5; }
        
        .card-blue { color: var(--primary); }
        .card-blue:hover { border-color: var(--primary); background: #eff6ff; }

        .menu-icon { font-size: 4rem; margin-bottom: 20px; }
        .menu-title { font-size: 1.5rem; font-weight: 800; }

        /* --- ì…ë ¥ í¼ ë° ë²„íŠ¼ --- */
        input, select, textarea {
            width: 100%; padding: 12px 15px; margin: 8px 0;
            border: 1px solid #e5e7eb; border-radius: 12px;
            font-size: 1rem; box-sizing: border-box; transition: border 0.2s;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: filter 0.2s; margin-top: 10px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #9ca3af; color: white; }
        .btn:hover { filter: brightness(0.9); }

        /* --- GitHub ì„¤ì • íŒ¨ë„ --- */
        .gh-settings {
            background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        .gh-status { font-size: 0.9rem; margin-top: 5px; }
        .gh-connected { color: var(--success); font-weight: bold; }
        .gh-disconnected { color: #ef4444; font-weight: bold; }

        /* --- í…Œì´ë¸” --- */
        .modern-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .modern-table th { background: #f9fafb; padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; color: #4b5563; }
        .modern-table td { padding: 12px; border-bottom: 1px solid #f3f4f6; color: #1f2937; }
        .modern-table tr:hover { background: #f9fafb; }

        /* --- í•€ ì½”ë“œ --- */
        .pin-area { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .pin-box { width: 50px; height: 60px; text-align: center; font-size: 24px; border-radius: 12px; border: 2px solid #e5e7eb; }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            .main-menu-grid { grid-template-columns: 1fr; height: auto; }
            .menu-card { height: 180px; }
            .card-panel { padding: 20px; height: 100%; border-radius: 0; max-width: 100%; display: flex; flex-direction: column; }
            body { background: white; }
        }

        /* í”Œë¡œíŒ… í™ˆ ë²„íŠ¼ */
        .fab-home {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: white; width: 50px; height: 50px;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="screen-main" class="container active">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 2.5rem; color: #1f2937; margin: 0;">ë°œí‘œ ì‹œìŠ¤í…œ</h1>
            <p style="color: #6b7280;">ì›í•˜ëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        </div>
        <div class="main-menu-grid">
            <div class="menu-card card-green" onclick="showUserList()">
                <i class="fas fa-search menu-icon"></i>
                <div class="menu-title">ë°œí‘œ ì¡°íšŒ</div>
            </div>
            <div class="menu-card card-blue" onclick="showAdminAuth()">
                <i class="fas fa-cog menu-icon"></i>
                <div class="menu-title">ë°œí‘œ ìƒì„±</div>
            </div>
        </div>
    </div>

    <div id="screen-auth" class="container">
        <div class="card-panel" style="max-width: 400px; text-align: center;">
            <h2>ê´€ë¦¬ì ì ‘ì†</h2>
            <p style="color:#666;">ë³´ì•ˆ ì½”ë“œ 5ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            <div class="pin-area">
                <input type="password" maxlength="1" class="pin-box">
                <input type="password" maxlength="1" class="pin-box">
                <input type="password" maxlength="1" class="pin-box">
                <input type="password" maxlength="1" class="pin-box">
                <input type="password" maxlength="1" class="pin-box">
            </div>
            <button class="btn btn-secondary" onclick="goHome()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="screen-admin" class="container">
        <div class="card-panel">
            <h2>âš™ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
            
            <div class="gh-settings">
                <h3 style="margin-top:0; font-size:1.1rem;"><i class="fab fa-github"></i> GitHub ì—°ë™ ì„¤ì •</h3>
                <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                    GitHub Tokenì„ ì…ë ¥í•˜ë©´ íŒŒì¼ ì—…ë¡œë“œ ì—†ì´ [ì €ì¥] ë²„íŠ¼ìœ¼ë¡œ ë°”ë¡œ ì‚¬ì´íŠ¸ì— ë°˜ì˜ë©ë‹ˆë‹¤.<br>
                    (ì •ë³´ëŠ” ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì„ ë•Œê¹Œì§€ë§Œ ìœ ì§€ë©ë‹ˆë‹¤)
                </p>
                <div style="display: grid; gap: 10px; grid-template-columns: 1fr 1fr;">
                    <input type="text" id="gh-owner" placeholder="GitHub ì•„ì´ë”” (ì˜ˆ: myname)">
                    <input type="text" id="gh-repo" placeholder="ì €ì¥ì†Œ ì´ë¦„ (ì˜ˆ: my-repo)">
                </div>
                <input type="password" id="gh-token" placeholder="GitHub Personal Access Token (ghp_...)" style="margin-bottom: 5px;">
                <button class="btn btn-primary" onclick="saveGhSettings()" style="padding: 8px; font-size: 0.9rem;">ì—°ë™ ì •ë³´ ì ìš©í•˜ê¸°</button>
                <div id="gh-status-msg" class="gh-status">ìƒíƒœ: <span class="gh-disconnected">ë¯¸ì—°ë™ (ìˆ˜ë™ ëª¨ë“œ)</span></div>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0;">ë°œí‘œ ëª©ë¡</h3>
                <button class="btn btn-primary" style="width: auto; margin:0;" onclick="showEditor()">+ ìƒˆ ë°œí‘œ ë§Œë“¤ê¸°</button>
            </div>
            
            <div id="admin-list-view">
                </div>

            <div style="margin-top: 20px; text-align: right;">
                 <button class="btn btn-secondary" style="width: auto;" onclick="downloadDB()">ğŸ’¾ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ (.txt)</button>
            </div>
        </div>
    </div>

    <div id="screen-editor" class="container">
        <div class="card-panel">
            <h2 id="editor-title">ë°œí‘œ ìƒì„±</h2>
            <input type="hidden" id="edit-idx">
            
            <label>ì œëª©</label>
            <input type="text" id="edit-title" placeholder="ì˜ˆ: 2026 ì‹ ì…ìƒ ë°˜í¸ì„±">
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:1;"><label>ì‹œì‘ì¼</label><input type="datetime-local" id="edit-start"></div>
                <div style="flex:1;"><label>ì¢…ë£Œì¼</label><input type="datetime-local" id="edit-end"></div>
            </div>

            <label>ë°ì´í„° (ì—‘ì…€ ì—…ë¡œë“œ ë˜ëŠ” ì§ì ‘ ì…ë ¥)</label>
            <input type="file" accept=".xlsx, .xls" onchange="loadExcel(this)">
            <textarea id="edit-data" rows="10" placeholder="í—¤ë”: <ì´ë¦„> <*ë°˜>&#13;&#10;ë°ì´í„°: í™ê¸¸ë™ 3" style="font-family: monospace;"></textarea>
            
            <button class="btn btn-success" onclick="saveData()">
                <i class="fas fa-cloud-upload-alt"></i> ì €ì¥ ë° ì‚¬ì´íŠ¸ ë°˜ì˜
            </button>
            <button class="btn btn-secondary" onclick="showScreen('screen-admin')">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="screen-user-list" class="container">
        <div class="card-panel">
            <h2>ğŸ“¢ ì§„í–‰ ì¤‘ì¸ ë°œí‘œ</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="search-keyword" placeholder="ë°œí‘œ ì œëª© ê²€ìƒ‰..." style="margin:0;">
                <button class="btn btn-primary" style="width: 80px; margin:0;" onclick="renderUserList()">ê²€ìƒ‰</button>
            </div>
            
            <table class="modern-table">
                <thead>
                    <tr><th>ì œëª©</th><th>ê¸°ê°„</th><th>ìƒíƒœ</th></tr>
                </thead>
                <tbody id="user-list-body"></tbody>
            </table>
        </div>
    </div>

    <div id="screen-query" class="container">
        <div class="card-panel" style="max-width: 500px;">
            <h2 id="query-header">ì¡°íšŒ</h2>
            <p id="query-period" style="text-align: center; color:#666; margin-bottom: 20px;"></p>
            
            <div id="query-inputs"></div>
            
            <button class="btn btn-primary" onclick="executeQuery()">ê²°ê³¼ í™•ì¸</button>
            
            <div id="query-result" style="margin-top: 20px; padding: 15px; background: #ecfdf5; border-radius: 12px; display: none;">
                </div>
            
            <button class="btn btn-secondary" onclick="showUserList()" style="margin-top: 10px;">ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>

    <div class="fab-home" onclick="goHome()">
        <i class="fas fa-home"></i>
    </div>

    <script>
        // --- ì„¤ì • ---
        const CONFIG = {
            dbFile: 'presentation.txt',
            secret: 'K0352_KEY', // ì•”í˜¸í™” í‚¤
            adminHash: '80f4139f4e2f8914b437292275b287532336338006e0013897b5e406f850e04d' // 'K0352' SHA256
        };

        let dbData = []; // ë©”ëª¨ë¦¬ DB
        let ghSettings = { owner: '', repo: '', token: '' };

        // --- ì´ˆê¸°í™” ---
        window.onload = async () => {
            setupPin();
            await loadFromGithub();
            
            // ì„¸ì…˜ì— ì €ì¥ëœ GitHub ì„¤ì • ë³µì›
            const savedGh = sessionStorage.getItem('gh_config');
            if(savedGh) {
                ghSettings = JSON.parse(savedGh);
                document.getElementById('gh-owner').value = ghSettings.owner;
                document.getElementById('gh-repo').value = ghSettings.repo;
                document.getElementById('gh-token').value = ghSettings.token;
                updateGhStatus(true);
            }
        };

        // --- í™”ë©´ ì „í™˜ ---
        function showScreen(id) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const fab = document.querySelector('.fab-home');
            fab.style.display = (id === 'screen-main') ? 'none' : 'flex';
        }

        function goHome() {
            showScreen('screen-main');
            document.querySelectorAll('.pin-box').forEach(i => i.value = '');
        }

        // --- GitHub API ë¡œì§ (í•µì‹¬) ---
        async function loadFromGithub() {
            try {
                // ìºì‹œ ë°©ì§€
                const res = await fetch(CONFIG.dbFile + '?t=' + Date.now());
                if(res.ok) {
                    const txt = await res.text();
                    const bytes = CryptoJS.AES.decrypt(txt, CONFIG.secret);
                    dbData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                }
            } catch(e) { console.log('DB Init or Empty'); }
        }

        function saveGhSettings() {
            ghSettings.owner = document.getElementById('gh-owner').value.trim();
            ghSettings.repo = document.getElementById('gh-repo').value.trim();
            ghSettings.token = document.getElementById('gh-token').value.trim();
            
            if(ghSettings.owner && ghSettings.repo && ghSettings.token) {
                sessionStorage.setItem('gh_config', JSON.stringify(ghSettings));
                updateGhStatus(true);
                alert('ì—°ë™ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function updateGhStatus(connected) {
            const el = document.getElementById('gh-status-msg');
            if(connected) el.innerHTML = 'ìƒíƒœ: <span class="gh-connected">ì—°ë™ ì™„ë£Œ (ìë™ ì €ì¥ ê°€ëŠ¥)</span>';
            else el.innerHTML = 'ìƒíƒœ: <span class="gh-disconnected">ë¯¸ì—°ë™ (ìˆ˜ë™ ë‹¤ìš´ë¡œë“œ í•„ìš”)</span>';
        }

        async function uploadToGithub(jsonStr) {
            if(!ghSettings.token) {
                alert('GitHub ì—°ë™ ì„¤ì •ì´ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. \n[DB ë‹¤ìš´ë¡œë“œ]ë¥¼ í†µí•´ ìˆ˜ë™ìœ¼ë¡œ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì—°ë™ ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”.');
                downloadDB(); // ìˆ˜ë™ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                return;
            }

            const encrypted = CryptoJS.AES.encrypt(jsonStr, CONFIG.secret).toString();
            const content = btoa(unescape(encodeURIComponent(encrypted))); // UTF-8 safe base64

            const url = `https://api.github.com/repos/${ghSettings.owner}/${ghSettings.repo}/contents/${CONFIG.dbFile}`;
            
            try {
                // 1. ê¸°ì¡´ íŒŒì¼ SHA ì¡°íšŒ
                let sha = null;
                const getRes = await fetch(url);
                if(getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                }

                // 2. PUT ìš”ì²­ (Create or Update)
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${ghSettings.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Web Update: ' + new Date().toLocaleString(),
                        content: content,
                        sha: sha
                    })
                });

                if(putRes.ok) {
                    alert('ì„±ê³µ! GitHub ì €ì¥ì†Œì— ë°ì´í„°ê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì‹¤ì œ í˜ì´ì§€ ë°˜ì˜ê¹Œì§€ 1~2ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
                    loadFromGithub(); // ìµœì‹ í™”
                } else {
                    const err = await putRes.json();
                    alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + err.message);
                }
            } catch(e) {
                alert('í†µì‹  ì˜¤ë¥˜: ' + e.message);
            }
        }

        // --- ê´€ë¦¬ì/ë°ì´í„° ë¡œì§ ---
        function showAdminAuth() {
            showScreen('screen-auth');
            document.querySelectorAll('.pin-box')[0].focus();
        }

        function setupPin() {
            const inputs = document.querySelectorAll('.pin-box');
            inputs.forEach((inp, idx) => {
                inp.addEventListener('keyup', async (e) => {
                    if(e.key === 'Backspace' && idx > 0 && !inp.value) inputs[idx-1].focus();
                    else if(inp.value && idx < 4) inputs[idx+1].focus();
                    
                    const code = Array.from(inputs).map(i=>i.value).join('');
                    if(code.length === 5) {
                        const hash = await sha256(code);
                        if(hash === CONFIG.adminHash) {
                            showScreen('screen-admin');
                            renderAdminList();
                        } else {
                            alert('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');
                            inputs.forEach(i=>i.value='');
                            inputs[0].focus();
                        }
                    }
                });
            });
        }

        async function sha256(msg) {
            const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
            return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }

        function renderAdminList() {
            const view = document.getElementById('admin-list-view');
            view.innerHTML = '';
            if(dbData.length === 0) view.innerHTML = '<p style="color:#666; text-align:center;">ë“±ë¡ëœ ë°œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            
            dbData.forEach((item, idx) => {
                const div = document.createElement('div');
                div.style = "background: white; border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem;">${item.title}</div>
                        <div style="font-size:0.8rem; color:#666;">${item.start} ~ ${item.end}</div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" style="width:auto; padding:8px 12px; margin:0;" onclick="showEditor(${idx})">ìˆ˜ì •</button>
                        <button class="btn" style="width:auto; background:#ef4444; color:white; padding:8px 12px; margin:0;" onclick="deleteItem(${idx})">ì‚­ì œ</button>
                    </div>
                `;
                view.appendChild(div);
            });
        }

        function showEditor(idx = null) {
            showScreen('screen-editor');
            const isNew = (idx === null);
            document.getElementById('editor-title').innerText = isNew ? "ìƒˆ ë°œí‘œ ìƒì„±" : "ë°œí‘œ ìˆ˜ì •";
            document.getElementById('edit-idx').value = isNew ? "" : idx;
            
            if(!isNew) {
                const d = dbData[idx];
                document.getElementById('edit-title').value = d.title;
                document.getElementById('edit-start').value = d.start;
                document.getElementById('edit-end').value = d.end;
                
                let txt = d.headers.join('\t') + '\n';
                d.data.forEach(row => txt += row.join('\t') + '\n');
                document.getElementById('edit-data').value = txt;
            } else {
                document.getElementById('edit-title').value = '';
                document.getElementById('edit-start').value = '';
                document.getElementById('edit-end').value = '';
                document.getElementById('edit-data').value = '';
            }
        }

        function loadExcel(input) {
            const reader = new FileReader();
            reader.onload = e => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                const csv = XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]], {FS:'\t'});
                document.getElementById('edit-data').value = csv;
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function saveData() {
            const idx = document.getElementById('edit-idx').value;
            const title = document.getElementById('edit-title').value;
            const start = document.getElementById('edit-start').value;
            const end = document.getElementById('edit-end').value;
            const raw = document.getElementById('edit-data').value.trim();

            if(!title || !start || !raw) return alert('í•„ìˆ˜ í•­ëª© ëˆ„ë½');

            const lines = raw.split('\n');
            const headers = lines[0].split(/[ \t]+/).filter(x=>x.trim()).map(h=>h.replace(/[<>]/g,''));
            const data = [];
            for(let i=1; i<lines.length; i++) {
                const r = lines[i].split(/[ \t]+/).filter(x=>x.trim());
                if(r.length) data.push(r);
            }

            const newObj = { title, start, end, headers, data };
            
            if(idx === "") dbData.push(newObj);
            else dbData[parseInt(idx)] = newObj;

            // ì €ì¥ ì‹œë„
            uploadToGithub(JSON.stringify(dbData));
            showScreen('screen-admin');
            renderAdminList();
        }

        function deleteItem(idx) {
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                dbData.splice(idx, 1);
                uploadToGithub(JSON.stringify(dbData));
                renderAdminList();
            }
        }

        function downloadDB() {
            const encrypted = CryptoJS.AES.encrypt(JSON.stringify(dbData), CONFIG.secret).toString();
            const blob = new Blob([encrypted], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = CONFIG.dbFile;
            a.click();
        }

        // --- ì‚¬ìš©ì ë¡œì§ ---
        function showUserList() {
            showScreen('screen-user-list');
            renderUserList();
        }

        function renderUserList() {
            const tbody = document.getElementById('user-list-body');
            const key = document.getElementById('search-keyword').value;
            tbody.innerHTML = '';
            
            const now = new Date();

            dbData.forEach((item, idx) => {
                if(key && !item.title.includes(key)) return;
                
                const s = new Date(item.start);
                const e = new Date(item.end);
                let btn = `<button class="btn btn-success" style="padding:6px 12px; margin:0; width:auto;" onclick="openQuery(${idx})">ì¡°íšŒ</button>`;
                
                if(now < s) btn = `<span style="color:#999; font-size:0.9rem;">ì‹œì‘ ì „</span>`;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold;">${item.title}</td>
                    <td style="font-size:0.9rem;">${item.start.replace('T',' ')} ~ <br>${item.end.replace('T',' ')}</td>
                    <td style="text-align:center;">${btn}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        let currQueryIdx = -1;
        function openQuery(idx) {
            currQueryIdx = idx;
            showScreen('screen-query');
            const item = dbData[idx];
            document.getElementById('query-header').innerText = item.title;
            document.getElementById('query-period').innerText = `${item.start.replace('T',' ')} ~ ${item.end.replace('T',' ')}`;
            document.getElementById('query-result').style.display = 'none';
            
            const container = document.getElementById('query-inputs');
            container.innerHTML = '';
            item.headers.forEach(h => {
                if(!h.startsWith('*')) {
                    container.innerHTML += `<label>${h}</label><input type="text" class="q-inp" data-h="${h}">`;
                }
            });
        }

        function executeQuery() {
            const item = dbData[currQueryIdx];
            const inps = document.querySelectorAll('.q-inp');
            const cond = {};
            inps.forEach(i => cond[i.dataset.h] = i.value.trim());

            // ê²€ìƒ‰
            const idCols = item.headers.map((h,i)=>({h,i})).filter(x=>!x.h.startsWith('*'));
            const row = item.data.find(r => idCols.every(c => r[c.i] === cond[c.h]));
            
            const resBox = document.getElementById('query-result');
            resBox.style.display = 'block';
            
            if(row) {
                resBox.style.background = '#ecfdf5'; // Green light
                let html = `<h3 style="color:#059669; text-align:center; margin-top:0;">ì¡°íšŒ ê²°ê³¼</h3>`;
                item.headers.forEach((h, i) => {
                    if(h.startsWith('*')) {
                        html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #d1fae5; padding-bottom:5px;">
                            <span style="color:#666;">${h.substring(1)}</span>
                            <span style="font-weight:bold; font-size:1.1rem;">${row[i]}</span>
                        </div>`;
                    }
                });
                resBox.innerHTML = html;
            } else {
                resBox.style.background = '#fef2f2'; // Red light
                resBox.innerHTML = `<p style="color:#dc2626; text-align:center; font-weight:bold;">ì¼ì¹˜í•˜ëŠ” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }
    </script>
</body>
</html>
